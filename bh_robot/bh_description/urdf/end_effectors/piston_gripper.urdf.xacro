<?xml version="1.0"?>

<robot name="hardware" xmlns:xacro="http://www.ros.org/wiki/xacro">
<!-- distance: 0 0 0.152 center of mass: 0.004 0.004 0.085 mass: 2.4 main gripper macro -->
<xacro:macro name="piston_gripper" params="parent *origin">
  <!-- Tool properties -->
  <xacro:property name="tool_mass" value="2.0" />
  <xacro:property name="tool_link_offset" value="0.00 0.00 0.12" />

  <!--  Here we define a dummy joint between the tip of the iiwa7 and the base of the tool.
  There is no offset between the two, that means the tool is attached at the robot flange. -->
  <joint name="tool_joint" type="fixed">
    <parent link="${parent}" />
    <child link = "tool_link" />
    <xacro:insert_block name="origin" />
  </joint>

  <!-- Here we define the geometry of the tool. We designed the tool ourselves, so we have a mesh file that represents it.
  Else, one can define it using a geometric representation that approximate it, like a cylinder (see commented lines) -->
  <link name="tool_link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.2"/>
      <xacro:box_inertia x="0.08" y="0.08" z="0.12" mass="0.2"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/chuck.stl"/>
      </geometry>
      <material name="Gold"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/chuck.stl"/>
      </geometry>
    </collision>
  </link>

  <gazebo reference="tool_link">
    <turnGravityOff>true</turnGravityOff>
    <material>Gazebo/Gold</material>
    <mu1>0.2</mu1>
    <mu2>0.2</mu2>
  </gazebo>

  <!--  Here we define another dummy joint. It is placed at the end of the tool, so we can then attach a frame at its TCP for control -->
  <joint name="tool_tip_joint" type="fixed">
    <parent link="tool_link" />
    <child link = "tool_link_ee" />
    <origin xyz="${tool_link_offset}" rpy="0 0 0" />
  </joint>

  <!--  The TCP frame is here defined -->
  <link name="tool_link_ee"/>

  <joint name="pifinger1_joint" type="prismatic">
    <parent link="tool_link" />
    <child link = "pifinger1_link" />
    <origin xyz="${0.07 * cos(0)} ${0.07 * sin(0)} 0.14" rpy="0 0 0" />
    <axis xyz="1 0 0"/>
    <limit lower="-0.035" upper="0.0" velocity="0.2" effort="500"/>
  </joint>

  <joint name="pifinger2_joint" type="prismatic">
    <parent link="tool_link" />
    <child link = "pifinger2_link" />
    <origin xyz="${0.07 * cos((2*PI)/3)} ${0.07 * sin((2*PI)/3)} 0.14" rpy="0 0 ${(2*PI)/3}" />
    <axis xyz="1 0 0"/>
    <limit lower="-0.035" upper="0.0" velocity="0.2" effort="500"/>
  </joint>

  <joint name="pifinger3_joint" type="prismatic">
    <parent link="tool_link" />
    <child link = "pifinger3_link" />
    <origin xyz="${0.07 * cos((-2*PI)/3)} ${0.07 * sin((-2*PI)/3)} 0.14" rpy="0 0 ${(-2*PI)/3}" />
    <axis xyz="1 0 0"/>
    <limit lower="-0.035" upper="0.0" velocity="0.2" effort="500"/>
  </joint>

  <link name="pifinger1_link">
    <inertial>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <mass value="0.2"/>
      <xacro:box_inertia x="0.02" y="0.01" z="0.05" mass="0.2"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/claw.stl"/>
      </geometry>
      <material name="Gold"/>
    </visual>
    <collision>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/claw.stl"/>
      </geometry>
    </collision>
  </link>

  <link name="pifinger2_link">
    <inertial>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <mass value="0.2"/>
      <xacro:box_inertia x="0.02" y="0.01" z="0.05" mass="0.2"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/claw.stl"/>
      </geometry>
      <material name="Gold"/>
    </visual>
    <collision>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/claw.stl"/>
      </geometry>
    </collision>
  </link>

  <link name="pifinger3_link">
    <inertial>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <mass value="0.2"/>
      <xacro:box_inertia x="0.02" y="0.01" z="0.05" mass="0.2"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/claw.stl"/>
      </geometry>
      <material name="Gold"/>
    </visual>
    <collision>
      <origin xyz="0 0 0.0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="package://bh_description/meshes/piston_gripper/claw.stl"/>
      </geometry>
    </collision>
  </link>

  <gazebo>
    <gripper name="grasping">
      <grasp_check>
          <attach_steps>1</attach_steps>
          <detach_steps>1</detach_steps>
          <min_contact_count>3</min_contact_count>
      </grasp_check>
      <gripper_link>pifinger1_link</gripper_link>
      <gripper_link>pifinger2_link</gripper_link>
      <gripper_link>pifinger3_link</gripper_link>
      <palm_link>tool_link</palm_link>
    </gripper>
  </gazebo>

  <gazebo reference="pifinger1_link">
    <turnGravityOff>true</turnGravityOff>
    <material>Gazebo/Gold</material>
    <mu1>10.0</mu1>
    <mu2>10.0</mu2>
  </gazebo>

  <gazebo reference="pifinger2_link">
    <turnGravityOff>true</turnGravityOff>
    <material>Gazebo/Gold</material>
    <mu1>10.0</mu1>
    <mu2>10.0</mu2>
  </gazebo>

  <gazebo reference="pifinger3_link">
    <turnGravityOff>true</turnGravityOff>
    <material>Gazebo/Gold</material>
    <mu1>10.0</mu1>
    <mu2>10.0</mu2>
  </gazebo>

  <transmission name="pifinger1_tran">
    <robotNamespace>/$(arg robot_name)</robotNamespace>
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="pifinger1_joint">
      <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="pifinger1_motor">
      <mechanicalReduction>1</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="pifinger2_tran">
    <robotNamespace>/$(arg robot_name)</robotNamespace>
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="pifinger2_joint">
      <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="pifinger2_motor">
      <mechanicalReduction>1</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="pifinger3_tran">
    <robotNamespace>/$(arg robot_name)</robotNamespace>
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="pifinger3_joint">
      <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="pifinger3_motor">
      <mechanicalReduction>1</mechanicalReduction>
    </actuator>
  </transmission>

</xacro:macro>
</robot>
